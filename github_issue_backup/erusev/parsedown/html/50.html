<!DOCTYPE html>
<html class='' lang='en'>
<head prefix='og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#'>
<meta http-equiv='content-type' content='text/html; charset=UTF-8'>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta http-equiv='Content-Language' content='en'>
<title>erusev/parsedown/50</title>
<link href='github-c486157afcc5f58155a921bc675afb08733fbaa8dcf39ac2104d3.css' media='all' rel='stylesheet'>
<link href='github2-da2e842cc3f0aaf33b727d0ef034243c12ab008fd09b24868b97.css' media='all' rel='stylesheet'>
<meta http-equiv='x-pjax-version' content='4426702614c8182f33d1780ad1169662'>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shCore.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shAutoloader.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushAppleScript.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushAS3.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushBash.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushColdFusion.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushCpp.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushCSharp.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushCss.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushDelphi.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushDiff.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushErlang.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushGroovy.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushJava.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushJavaFX.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/syntaxhighlighter/scripts/shBrushJScript.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushPerl.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushPhp.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushPlain.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushPowerShell.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushPython.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushRuby.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushSass.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushScala.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushSql.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushVb.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shBrushXml.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shCore.js'></script>
	<script type='text/javascript' src='syntaxhighlighter/scripts/shLegacy.js'></script>
	<link type='text/css' rel='stylesheet' href='syntaxhighlighter/styles/shCoreDefault.css'/>
	<script type='text/javascript'>SyntaxHighlighter.all();</script>
</head>
<body class='logged_in  env-production windows vis-public'>
<h1 align='center'><a href='https://github.com/erusev/parsedown/issues/50' target='_blank'>Double html-entity encoding in code blocks</h1><hr/><div id="#issue-24672764" class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment current-user" data-body-version="3d69eb2502aec4738da37c0867d635da">
  <div class="timeline-comment-header ">
  <div class="timeline-comment-header-text">
    <strong>
      <a href="https://github.com/drrcknlsn" class="author">drrcknlsn</a>
    </strong>
    commented on 
    <a href="#issue-24672764" class="timestamp">
      <time>2013-12-21 23:22:51</time>
    </a>
  </div>
</div><div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>If the markdown to be parsed comes directly from a user (as in a comment or post), then we must use <code>htmlentities()</code> or <code>htmlspecialchars()</code> prior to parsing it, in order to prevent XSS:</p>
<pre class="brush: php">$_POST['markdown'] = &lt;&lt;&lt;'MD'
&lt;script&gt;alert('xss');&lt;/script&gt;
~~~php
$foo = true &amp;&amp; (1 &lt; 7 ? "bar" : '&gt;');
\~~~
MD;

// Bad!
$markup = Parsedown::instance()-&gt;parse($_POST['markdown']);

// Good
$markdown = htmlspecialchars($_POST['markdown'], ENT_QUOTES, 'UTF-8');
$markup = Parsedown::instance()-&gt;parse($markdown);</code></pre>
<p>The problem here is that any entities within fenced code blocks then become double-encoded, because these are encoded internally by Parsedown.</p>
<p>My first thought was to simply use <code>strip_tags()</code> instead of encoding; however, this breaks markdown code blocks that contain HTML/XML, as <code>strip_tags()</code> is not context-aware.</p>
<p>My next thought was to change the <code>htmlspecialchars()</code> calls within Parsedown - where we encode the contents of fenced code blocks - to use the 4th parameter (<code>$double_encode</code>) and turn off double-encoding.  Unfortunately, that leaves us with the problem of not being able to represent literal encoded entities within code blocks, e.g.:</p>
<pre class="brush: php">$foo = '&amp;amp;';</code></pre>
<p>We can require the calling code to cherry-pick the parts of the input to encode entities in (everything but the content between code block fences), but that requires a fair bit of markdown parsing <em>outside the actual markdown parser</em>.</p>
<p>The only other thing I can think of would be to use a DOM parser in conjunction with <code>htmlspecialchars_decode()</code> to un-double-encode things inside <code>&lt;code&gt;&lt;/code&gt;</code> blocks in the parsed markdown, but this seems like it would just be putting a band-aid on the problem instead of actually fixing it.</p>
<p>I don't have a good solution in mind yet; I just wanted to make the issue known and open discussion (maybe I missed something obvious).</p>
  </div>
  </div>
  </div>
  <br/>
<div id="#issuecomment-31075111" class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment current-user" data-body-version="3d69eb2502aec4738da37c0867d635da">
  <div class="timeline-comment-header ">
  <div class="timeline-comment-header-text">
    <strong>
      <a href="https://github.com/erusev" class="author">erusev</a>
    </strong>
    commented on 
    <a href="#issuecomment-31075111" class="timestamp">
      <time>2013-12-21 23:40:19</time>
    </a>
  </div>
</div><div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><strong><a href="https://github.com/drrcknlsn" target="_blank">@drrcknlsn</a></strong> Markdown parsers convert Markdown texts into HTML. Usually, they are not responsible for sanitization. I'm thinking about adding sanitization capabilities but it's too early to give promises. At this point you could sanitize your texts with libraries like <a href="http://htmlpurifier.org/">HTML Purifier</a>.</p>
  </div>
  </div>
  </div>
  <br/>
<div id="#issuecomment-38119963" class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment current-user" data-body-version="3d69eb2502aec4738da37c0867d635da">
  <div class="timeline-comment-header ">
  <div class="timeline-comment-header-text">
    <strong>
      <a href="https://github.com/DeathSeeker512" class="author">DeathSeeker512</a>
    </strong>
    commented on 
    <a href="#issuecomment-38119963" class="timestamp">
      <time>2014-03-19 23:26:20</time>
    </a>
  </div>
</div><div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>If you remove all instances of</p>
<pre class="brush: php">htmlspecialchars($var, ENT_NOQUOTES, 'UTF-8');</code></pre>
<p>to where it just has the variable, it will fix the issues, but you should then have</p>
<pre class="brush: php">$parsedown-&gt;parse(htmlspecialchars($text, ENT_NOQUOTES, 'UTF-8'));</code></pre>
<p>This fixes the issue.</p>
  </div>
  </div>
  </div>
  <br/>
<div id="#issuecomment-63785203" class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment current-user" data-body-version="3d69eb2502aec4738da37c0867d635da">
  <div class="timeline-comment-header ">
  <div class="timeline-comment-header-text">
    <strong>
      <a href="https://github.com/miguel-velazkez" class="author">miguel-velazkez</a>
    </strong>
    commented on 
    <a href="#issuecomment-63785203" class="timestamp">
      <time>2014-11-20 09:58:04</time>
    </a>
  </div>
</div><div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p><strong><a href="https://github.com/drrcknlsn" target="_blank">@drrcknlsn</a></strong> What I did is instead of using htmlentities or htmlspecialchars before parsing.
Instead I just used </p>
<pre class="brush: php">$parsedown-&gt;setMarkupEscaped(true)-&gt;text($text);</code></pre>
<p>this way whatever is outside a codeblock is encoded and whatever is inside a codeblock is encoded just once.
I was strugling with this as well but found the examples wiki...
<a href="https://github.com/erusev/parsedown/wiki/Usage">https://github.com/erusev/parsedown/wiki/Usage</a></p>
  </div>
  </div>
  </div>
  <br/>
</body></html>