{
  "url": "https://api.github.com/repos/erusev/parsedown/issues/50",
  "labels_url": "https://api.github.com/repos/erusev/parsedown/issues/50/labels{/name}",
  "comments_url": "https://api.github.com/repos/erusev/parsedown/issues/50/comments",
  "events_url": "https://api.github.com/repos/erusev/parsedown/issues/50/events",
  "html_url": "https://github.com/erusev/parsedown/issues/50",
  "id": 24672764,
  "number": 50,
  "title": "Double html-entity encoding in code blocks",
  "user": {
    "login": "drrcknlsn",
    "id": 2717358,
    "avatar_url": "https://avatars.githubusercontent.com/u/2717358?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drrcknlsn",
    "html_url": "https://github.com/drrcknlsn",
    "followers_url": "https://api.github.com/users/drrcknlsn/followers",
    "following_url": "https://api.github.com/users/drrcknlsn/following{/other_user}",
    "gists_url": "https://api.github.com/users/drrcknlsn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drrcknlsn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drrcknlsn/subscriptions",
    "organizations_url": "https://api.github.com/users/drrcknlsn/orgs",
    "repos_url": "https://api.github.com/users/drrcknlsn/repos",
    "events_url": "https://api.github.com/users/drrcknlsn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drrcknlsn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "milestone": null,
  "comments": 3,
  "created_at": "2013-12-21T23:22:51Z",
  "updated_at": "2014-11-20T09:58:04Z",
  "closed_at": "2013-12-23T07:54:16Z",
  "body": "If the markdown to be parsed comes directly from a user (as in a comment or post), then we must use `htmlentities()` or `htmlspecialchars()` prior to parsing it, in order to prevent XSS:\r\n\r\n```php\r\n$_POST['markdown'] = <<<'MD'\r\n<script>alert('xss');</script>\r\n~~~php\r\n$foo = true && (1 < 7 ? \"bar\" : '>');\r\n\\~~~\r\nMD;\r\n\r\n// Bad!\r\n$markup = Parsedown::instance()->parse($_POST['markdown']);\r\n\r\n// Good\r\n$markdown = htmlspecialchars($_POST['markdown'], ENT_QUOTES, 'UTF-8');\r\n$markup = Parsedown::instance()->parse($markdown);\r\n```\r\n\r\nThe problem here is that any entities within fenced code blocks then become double-encoded, because these are encoded internally by Parsedown.\r\n\r\nMy first thought was to simply use `strip_tags()` instead of encoding; however, this breaks markdown code blocks that contain HTML/XML, as `strip_tags()` is not context-aware.\r\n\r\nMy next thought was to change the `htmlspecialchars()` calls within Parsedown - where we encode the contents of fenced code blocks - to use the 4th parameter (`$double_encode`) and turn off double-encoding.  Unfortunately, that leaves us with the problem of not being able to represent literal encoded entities within code blocks, e.g.:\r\n\r\n```php\r\n$foo = '&amp;';\r\n```\r\n\r\nWe can require the calling code to cherry-pick the parts of the input to encode entities in (everything but the content between code block fences), but that requires a fair bit of markdown parsing *outside the actual markdown parser*.\r\n\r\nThe only other thing I can think of would be to use a DOM parser in conjunction with `htmlspecialchars_decode()` to un-double-encode things inside `<code></code>` blocks in the parsed markdown, but this seems like it would just be putting a band-aid on the problem instead of actually fixing it.\r\n\r\nI don't have a good solution in mind yet; I just wanted to make the issue known and open discussion (maybe I missed something obvious).",
  "closed_by": {
    "login": "erusev",
    "id": 184170,
    "avatar_url": "https://avatars.githubusercontent.com/u/184170?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/erusev",
    "html_url": "https://github.com/erusev",
    "followers_url": "https://api.github.com/users/erusev/followers",
    "following_url": "https://api.github.com/users/erusev/following{/other_user}",
    "gists_url": "https://api.github.com/users/erusev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/erusev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/erusev/subscriptions",
    "organizations_url": "https://api.github.com/users/erusev/orgs",
    "repos_url": "https://api.github.com/users/erusev/repos",
    "events_url": "https://api.github.com/users/erusev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/erusev/received_events",
    "type": "User",
    "site_admin": false
  }
}
BODY STARTS FROM HERE
[
  {
    "url": "https://api.github.com/repos/erusev/parsedown/issues/comments/31075111",
    "html_url": "https://github.com/erusev/parsedown/issues/50#issuecomment-31075111",
    "issue_url": "https://api.github.com/repos/erusev/parsedown/issues/50",
    "id": 31075111,
    "user": {
      "login": "erusev",
      "id": 184170,
      "avatar_url": "https://avatars.githubusercontent.com/u/184170?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/erusev",
      "html_url": "https://github.com/erusev",
      "followers_url": "https://api.github.com/users/erusev/followers",
      "following_url": "https://api.github.com/users/erusev/following{/other_user}",
      "gists_url": "https://api.github.com/users/erusev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/erusev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/erusev/subscriptions",
      "organizations_url": "https://api.github.com/users/erusev/orgs",
      "repos_url": "https://api.github.com/users/erusev/repos",
      "events_url": "https://api.github.com/users/erusev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/erusev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2013-12-21T23:40:19Z",
    "updated_at": "2013-12-21T23:48:41Z",
    "body": "@drrcknlsn Markdown parsers convert Markdown texts into HTML. Usually, they are not responsible for sanitization. I'm thinking about adding sanitization capabilities but it's too early to give promises. At this point you could sanitize your texts with libraries like [HTML Purifier](http://htmlpurifier.org/)."
  },
  {
    "url": "https://api.github.com/repos/erusev/parsedown/issues/comments/38119963",
    "html_url": "https://github.com/erusev/parsedown/issues/50#issuecomment-38119963",
    "issue_url": "https://api.github.com/repos/erusev/parsedown/issues/50",
    "id": 38119963,
    "user": {
      "login": "DeathSeeker512",
      "id": 3769904,
      "avatar_url": "https://avatars.githubusercontent.com/u/3769904?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DeathSeeker512",
      "html_url": "https://github.com/DeathSeeker512",
      "followers_url": "https://api.github.com/users/DeathSeeker512/followers",
      "following_url": "https://api.github.com/users/DeathSeeker512/following{/other_user}",
      "gists_url": "https://api.github.com/users/DeathSeeker512/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DeathSeeker512/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DeathSeeker512/subscriptions",
      "organizations_url": "https://api.github.com/users/DeathSeeker512/orgs",
      "repos_url": "https://api.github.com/users/DeathSeeker512/repos",
      "events_url": "https://api.github.com/users/DeathSeeker512/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DeathSeeker512/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2014-03-19T23:26:20Z",
    "updated_at": "2014-03-19T23:26:32Z",
    "body": "If you remove all instances of\r\n```php\r\nhtmlspecialchars($var, ENT_NOQUOTES, 'UTF-8');\r\n```\r\nto where it just has the variable, it will fix the issues, but you should then have\r\n```php\r\n$parsedown->parse(htmlspecialchars($text, ENT_NOQUOTES, 'UTF-8'));\r\n```\r\n\r\nThis fixes the issue."
  },
  {
    "url": "https://api.github.com/repos/erusev/parsedown/issues/comments/63785203",
    "html_url": "https://github.com/erusev/parsedown/issues/50#issuecomment-63785203",
    "issue_url": "https://api.github.com/repos/erusev/parsedown/issues/50",
    "id": 63785203,
    "user": {
      "login": "miguel-velazkez",
      "id": 4377651,
      "avatar_url": "https://avatars.githubusercontent.com/u/4377651?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/miguel-velazkez",
      "html_url": "https://github.com/miguel-velazkez",
      "followers_url": "https://api.github.com/users/miguel-velazkez/followers",
      "following_url": "https://api.github.com/users/miguel-velazkez/following{/other_user}",
      "gists_url": "https://api.github.com/users/miguel-velazkez/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/miguel-velazkez/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miguel-velazkez/subscriptions",
      "organizations_url": "https://api.github.com/users/miguel-velazkez/orgs",
      "repos_url": "https://api.github.com/users/miguel-velazkez/repos",
      "events_url": "https://api.github.com/users/miguel-velazkez/events{/privacy}",
      "received_events_url": "https://api.github.com/users/miguel-velazkez/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2014-11-20T09:58:04Z",
    "updated_at": "2014-11-20T09:58:04Z",
    "body": "@drrcknlsn What I did is instead of using htmlentities or htmlspecialchars before parsing. \r\nInstead I just used \r\n```php\r\n$parsedown->setMarkupEscaped(true)->text($text);\r\n```\r\nthis way whatever is outside a codeblock is encoded and whatever is inside a codeblock is encoded just once. \r\nI was strugling with this as well but found the examples wiki...\r\nhttps://github.com/erusev/parsedown/wiki/Usage"
  }
]
